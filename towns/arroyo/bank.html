<!DOCTYPE html>
<html>

<head>

    <title>Банк Арройо</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../javascript/leaflet/leaflet.css">
    <script src="../../javascript/leaflet/leaflet.js"></script>
    <style>
        .leaflet-popup {
            margin-bottom: 0px;
        }

        .leaflet-popup-tip-container {
            display: none;
        }

        .leaflet-popup-content-wrapper {
            padding: 0px;
        }

        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: none;
            color: Moccasin;
            box-shadow: none;
        }

        .leaflet-container a.leaflet-popup-close-button {
            color: white;
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0 19px;
        }
    </style>
</head>


<body>
    <div id='map'></div>
    <script>

        let npc = [
            {
                name: "Охранник",
                crds: [
                [308.875, 573.125],
                [334.875, 890.625],
                [537.5, 427.75],
                [551.125, 635.375],
                [478.625, 733.625],
                [443.25, 780.125],
                [562.375, 717],
                [430.125, 987.625],
                [491.5, 1164.875],
                [633.75, 1035.125]
                ]
            },
            {
                name: "Кладовщик",
                crds: [583.875, 1001.75]
            },
            {
                name: "Хаболог",
                crds: [479.625, 540.5]
            },
        ]

        let npcGrp = L.layerGroup();
        let npcPopup = {};
        let popupOptions = {
            autoClose: false,
            closeOnClick: false,
            closeOnEscapeKey: false,
            closeButton: true,
            minWidth: 20
        }

        for (let index of npc) {
            if (Array.isArray(index.crds[0])) {
                for (coords of index.crds) {
                    npcGrp.addLayer(
                        npcPopup[npc.indexOf(index)] = L.popup(popupOptions)
                            .setLatLng(coords)
                            .setContent(`<b>${index.name}</b>`)
                    )
                }
            } else {
                npcGrp.addLayer(
                    npcPopup[npc.indexOf(index)] = L.popup(popupOptions)
                        .setLatLng(index.crds)
                        .setContent(`<b style ='color: white'>${index.name}</b>`)
                )
            }
        }

        let bounds = [[0, 0], [885, 1448]];
        let classicMap = L.imageOverlay('../../locations/arroyo/repl_bank_arroyo_1.jpg', bounds);
        let noRoofMap = L.imageOverlay('../../locations/arroyo/repl_bank_arroyo_2.jpg', bounds);

        let map = L.map('map', {
            crs: L.CRS.Simple,
            layers: [classicMap, npcGrp],
            attributionControl: false,
            zoomControl: false,
            doubleClickZoom: false,
            minZoom: -2,
            maxZoom: 3,
            maxBoundsViscosity: 1,
            maxBounds: [
                [-5000, 5000],
                [5000, -5000]
            ],
        });
        map.fitBounds(bounds);
        let baseMaps = {
            "Стандартный вид": classicMap,
            "Без крыши и стен": noRoofMap,
        }
        let overlayMaps = {
            "Имена НПЦ": npcGrp,
        }
        L.control.layers(baseMaps, overlayMaps).addTo(map);

        let latlngsBank = [
            [398.25, 446.75],
            [505.5, 447.75],
            [512.25, 472.25],
            [403.25, 472.5]
        ];

        function onExitGrid(e) {
            if (e.target.exit) {
                return window.location.href = '../../index.html';
            } else {
                return window.location.href = e.target.link;
            }
        }

        // Оформление перехода на другую локацию
        let nextLocOptions = {
            color: 'green',
            opacity: 0.1,
        }

        let bankGrid = L.polygon(latlngsBank, nextLocOptions).addTo(map).on('click', onExitGrid);
        bankGrid.link = './main.html';

        function onMapClick(e) {
            console.log(`[${e.latlng.lat}, ${e.latlng.lng}]`)
        }
        map.on('click', onMapClick);
    </script>
</body>

</html>